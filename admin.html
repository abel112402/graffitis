<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="headerStyle.css">
<link rel="stylesheet" href="adminStyle.css">
<title>Admin oldal</title>
</head>

<header></header>

<body>
<div id="body">
  <h1 class="admin-h1">Admin oldal</h1>

  <div id="adminSection" style="display:none;">
    <h2>Moderáció</h2>
    <ul id="moderationList"></ul>

    <h2>Kategóriák kezelése</h2>
    <input type="text" id="newCategory" placeholder="Új kategória neve">
    <button id="addCategoryBtn">Hozzáadás</button>
    <ul id="categoryList"></ul>
  </div>
</div>

<script type="module">
import { supabase } from './supabaseClient.js';
import isAdmin from './isAdmin.js';

window.logout = async function logout() {
  await supabase.auth.signOut();
  alert('Kijelentkeztél.');
  location.href = '/';
}

const header = document.querySelector('header');
header.innerHTML = `
  <nav><a href="./">Főoldal</a></nav>
  <nav><a href="./" onclick="logout()">Kijelentkezés</a></nav>
  <nav id="upload-button"><a href="./upload.html">Graffiti Feltöltés</a></nav>
</nav>
`;

const adminLoggedIn = await isAdmin();
if (!adminLoggedIn) {
  alert('Nincs admin jogosultságod.');
  location.href = '/';
} else {
  document.getElementById('adminSection').style.display = 'block';

  // --- Moderációs graffitik betöltése ---
  async function loadModeration() {
    const { data, error } = await supabase
      .from('graffiti')
      .select('*')
      .eq('accepted', false)
      .order('created_at', { ascending: false });

    if (error) return console.error(error);

    const modList = document.getElementById('moderationList');
    modList.innerHTML = '';

    data.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${item.name} - Feltöltve: ${new Date(item.created_at).toLocaleString()}</span>`;

      // kattintás átirányítás
      li.querySelector('span').onclick = () => {
        window.location.href = `/graffiti.html?slug=${item.slug}`;
      };

      // Jóváhagyás gomb
      const approveBtn = document.createElement('button');
      approveBtn.innerText = 'Jóváhagyás';
      approveBtn.onclick = async (e) => {
        e.stopPropagation();

        // Graffiti jelenlegi adatai
        const { data: graffitiData, error: graffitiErr } = await supabase
          .from('graffiti')
          .select('category_id, new_category')
          .eq('id', item.id)
          .single();

        if (graffitiErr) {
          console.error("Hiba graffiti lekéréskor:", graffitiErr);
          return;
        }

        let updatedCategoryIds = graffitiData.category_id || [];

        // Új kategória beszúrása, ha megadott
        if (graffitiData.new_category) {
          for (const n of graffitiData.new_category) {
            const { data: catInsertData, error: catError } = await supabase
              .from('category')
              .insert([{ category_name: n }])
              .select('id'); // ne használj .single(), mert insert tömböt ad vissza

            if (catError) {
              console.error("Hiba az új kategória hozzáadásakor:", catError);
            } else if (catInsertData.length) {
              // Új category-id hozzáadása a listához
              updatedCategoryIds.push(catInsertData[0].id);
            }
          }
        }

        // Graffiti frissítése: accepted=true, category-id frissítve, new_category törlése
        const { error: updateError } = await supabase
          .from('graffiti')
          .update({
            accepted: true,
            new_category: null,
            category_id: updatedCategoryIds
          })
          .eq('id', item.id);

        if (updateError) {
          alert('Hiba a jóváhagyás során: ' + updateError.message);
          return;
        }

        loadCategories();
        li.remove();
      };

      // Törlés gomb
      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = 'Törlés';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const { error } = await supabase
          .from('graffiti')
          .delete()
          .eq('id', item.id);
        if (error) alert('Hiba a törlés során: ' + error.message);
        else li.remove();
      };

      li.appendChild(approveBtn);
      li.appendChild(deleteBtn);
      modList.appendChild(li);
    });
  }
  await loadModeration();

  // --- Kategóriák betöltése ---
  async function loadCategories() {
    const { data, error } = await supabase
      .from('category')
      .select('id, category_name')
      .order('category_name', { ascending: true });

    if (error) return console.error(error);

    const catList = document.getElementById('categoryList');
    catList.innerHTML = '';

    data.forEach(cat => {
      const li = document.createElement('li');
      li.textContent = cat.category_name;
      li.style.fontSize = 'clamp(1.4rem, 1.6vw, 1.6rem)';

      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = 'Törlés';
      deleteBtn.onclick = async () => {
        const { error } = await supabase
          .from('category')
          .delete()
          .eq('id', cat.id);
        if (error) alert('Hiba a törlés során: ' + error.message);
        else li.remove();
      };

      li.appendChild(deleteBtn);
      catList.appendChild(li);
    });
  }
  await loadCategories();

  // --- Új kategória hozzáadása ---
  document.getElementById('addCategoryBtn').onclick = async () => {
    const input = document.getElementById('newCategory');
    const name = input.value.trim();
    if (!name) return alert('Adj meg kategória nevet!');
    const { error } = await supabase
      .from('category')
      .insert([{ category_name: name }]);
    if (error) alert('Hiba a hozzáadás során: ' + error.message);
    else {
      input.value = '';
      await loadCategories();
    }
  };
}
</script>
</body>
</html>
